<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sativa Master | High End Experience</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-green: #39ff14;
            --deep-green: #0a1f0a;
            --smoke-white: #f0f0f0;
            --ember-orange: #ff4500;
            --bg-color: #050505;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none; /* Metin seçimini engelle */
            -webkit-user-drag: none;
        }

        body {
            background-color: var(--bg-color);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden; /* Scroll yok */
            width: 100vw;
            height: 100vh;
        }

        /* 3D SAHNE */
        #canvas-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            outline: none;
        }

        /* UI KATMANI */
        #ui-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none; /* Tıklamalar arkaya geçsin */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* ORTAK BUTON VE YAZI STİLLERİ */
        .interactive-element {
            pointer-events: auto; /* Sadece bunlar tıklanabilir */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            text-transform: uppercase;
            color: transparent;
            -webkit-text-stroke: 2px var(--neon-green);
            text-shadow: 0 0 30px rgba(57, 255, 20, 0.3);
            margin-bottom: 20px;
            text-align: center;
        }

        p.subtitle {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 5px;
            margin-bottom: 50px;
            text-align: center;
        }

        .btn-main {
            background: rgba(57, 255, 20, 0.1);
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            padding: 15px 50px;
            font-size: 1.5rem;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            border-radius: 5px;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.2);
        }

        .btn-main:hover {
            background: var(--neon-green);
            color: black;
            box-shadow: 0 0 50px rgba(57, 255, 20, 0.8);
            transform: scale(1.05);
        }

        /* AŞAMA 2: SARMA BARI */
        .progress-container {
            position: absolute;
            bottom: 20%;
            width: 300px;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            display: none; /* JS ile açılacak */
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: var(--neon-green);
            box-shadow: 0 0 20px var(--neon-green);
            transition: width 0.1s linear;
        }

        .instruction-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: white;
            margin-top: 20px;
            text-align: center;
            text-shadow: 0 0 10px black;
            animation: pulse 1.5s infinite;
        }

        /* AŞAMA 3: İÇME KONTROLLERİ */
        .smoke-controls {
            position: absolute;
            bottom: 10%;
            text-align: center;
            display: none; /* JS ile açılacak */
        }

        .key-hint {
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 4px;
            background: rgba(0,0,0,0.5);
            color: var(--neon-green);
            font-weight: bold;
            margin-right: 5px;
        }

        /* SONUÇ EKRANI */
        .end-screen {
            display: none;
            background: rgba(0,0,0,0.8);
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* YÜKLENİYOR */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--neon-green);
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
        }
    </style>
</head>
<body>

    <div id="loader">SİSTEM YÜKLENİYOR...</div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        
        <div id="hero-section" class="interactive-element">
            <h1>SATIVA</h1>
            <p class="subtitle">BOTANİK SANAT DENEYİMİ</p>
            <button class="btn-main" id="start-btn">BAŞLA</button>
        </div>

        <div id="rolling-ui" style="display:none;">
            <div class="progress-container">
                <div class="progress-fill" id="roll-bar"></div>
            </div>
            <div class="instruction-text" id="roll-text">
                <span class="key-hint">BOŞLUK / SPACE</span> TUŞUNA BASILI TUT
            </div>
        </div>

        <div id="smoking-ui" class="smoke-controls">
            <div class="instruction-text" style="font-size: 1rem; line-height: 2;">
                <div><span class="key-hint">MOUSE SOL TIK</span> BASILI TUT: İÇİNE ÇEK</div>
                <div><span class="key-hint">BIRAK</span>: DUMANI ÜFLE</div>
            </div>
        </div>

        <div id="end-screen" class="end-screen interactive-element">
            <h2 style="font-family:'Orbitron'; color:white; font-size:3rem; margin-bottom:20px;">DENEYİM TAMAMLANDI</h2>
            <button class="btn-main" id="restart-btn">TEKRARLA</button>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        /**
         * SATIVA CORE ENGINE
         * High Performance, Procedural, Robust State Machine
         */

        // --- YAPILANDIRMA ---
        const CONFIG = {
            colors: {
                bg: 0x050505,
                leaf: 0x2d5a27,
                paper: 0xeaeaea,
                filter: 0xd2a679,
                ember: 0xff3300,
                ash: 0x333333
            },
            joint: {
                length: 4.5,
                radius: 0.15,
                burnSpeed: 0.008 // Yanma hızı
            }
        };

        // --- GLOBAL DEĞİŞKENLER ---
        let scene, camera, renderer;
        let leafGroup, jointContainer, jointBody, emberMesh, jointFilter;
        let smokeParticles = [];
        let mouse = new THREE.Vector2();
        let smokeTexture;

        // --- DURUM YÖNETİMİ (STATE MACHINE) ---
        const STATE = {
            current: 'LOADING', // LOADING, INTRO, ROLLING, SMOKING, END
            rollProgress: 0,
            isRolling: false,
            isInhaling: false,
            currentJointLength: CONFIG.joint.length
        };

        // --- 1. BAŞLATMA (INIT) ---
        function init() {
            const container = document.getElementById('canvas-container');

            // Sahne
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.bg);
            scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.02);

            // Kamera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 0, 12);

            // Renderer (Yüksek Kalite Ayarları)
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Retina ekran desteği
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // Işıklandırma
            setupLighting();

            // Dokular
            smokeTexture = generateSmokeTexture();

            // Objeler
            createProceduralLeaf();
            createJointSystem();

            // Event Listeners
            window.addEventListener('resize', onWindowResize, false);
            window.addEventListener('mousemove', onMouseMove, false);

            // UI Butonları
            document.getElementById('start-btn').addEventListener('click', startExperience);
            document.getElementById('restart-btn').addEventListener('click', resetExperience);

            // Sarma Kontrolleri (Space)
            document.addEventListener('keydown', (e) => {
                if (STATE.current === 'ROLLING' && e.code === 'Space') {
                    STATE.isRolling = true;
                }
            });
            document.addEventListener('keyup', (e) => {
                if (STATE.current === 'ROLLING' && e.code === 'Space') {
                    STATE.isRolling = false;
                }
            });
            // Mobil için sarma
            document.addEventListener('touchstart', (e) => {
                if (STATE.current === 'ROLLING') STATE.isRolling = true;
            });
            document.addEventListener('touchend', (e) => {
                if (STATE.current === 'ROLLING') STATE.isRolling = false;
            });

            // İçme Kontrolleri (Mouse)
            document.addEventListener('mousedown', () => { if(STATE.current === 'SMOKING') startInhale(); });
            document.addEventListener('mouseup', () => { if(STATE.current === 'SMOKING') stopInhale(); });
            // Mobil için içme
            document.addEventListener('touchstart', (e) => { if(STATE.current === 'SMOKING') startInhale(); });
            document.addEventListener('touchend', (e) => { if(STATE.current === 'SMOKING') stopInhale(); });

            // Yükleme Bitti
            document.getElementById('loader').style.display = 'none';
            STATE.current = 'INTRO';

            // Döngü Başlat
            animate();
        }

        function setupLighting() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);

            const spotLight = new THREE.SpotLight(0x39ff14, 1.5); // Neon yeşil spot
            spotLight.position.set(5, 10, 5);
            spotLight.castShadow = true;
            spotLight.shadow.mapSize.width = 1024;
            spotLight.shadow.mapSize.height = 1024;
            scene.add(spotLight);

            const rimLight = new THREE.PointLight(0xffaa00, 0.5); // Sıcak kenar ışığı
            rimLight.position.set(-5, 2, -5);
            scene.add(rimLight);
        }

        // --- 2. OBJE OLUŞTURMA (MODELLEME) ---
        
        // Kenevir Yaprağı (Prosedürel Çizim)
        function createProceduralLeaf() {
            leafGroup = new THREE.Group();

            const leafShape = new THREE.Shape();
            leafShape.moveTo(0, 0);
            leafShape.bezierCurveTo(0.2, 0.5, 0.2, 1.5, 0, 2.5); // Sağ kenar
            leafShape.bezierCurveTo(-0.2, 1.5, -0.2, 0.5, 0, 0); // Sol kenar

            const geometry = new THREE.ShapeGeometry(leafShape);
            const material = new THREE.MeshStandardMaterial({
                color: CONFIG.colors.leaf,
                roughness: 0.6,
                metalness: 0.1,
                side: THREE.DoubleSide,
                emissive: 0x0a1f0a
            });

            // 7 Parçalı yaprak yapısı
            const angles = [0, 20, -20, 45, -45, 70, -70];
            const scales = [1, 0.9, 0.9, 0.75, 0.75, 0.5, 0.5];

            angles.forEach((angle, i) => {
                const leaflet = new THREE.Mesh(geometry, material);
                leaflet.rotation.z = THREE.MathUtils.degToRad(-angle);
                leaflet.scale.setScalar(scales[i]);
                leaflet.position.y = -0.5;
                leafGroup.add(leaflet);
            });

            scene.add(leafGroup);
        }

        // Sigara Sistemi (Filtre + Kağıt + Köz)
        function createJointSystem() {
            jointContainer = new THREE.Group();

            // 1. Filtre (Sabit)
            const filterGeo = new THREE.CylinderGeometry(CONFIG.joint.radius, CONFIG.joint.radius, 1, 32);
            const filterMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.filter });
            jointFilter = new THREE.Mesh(filterGeo, filterMat);
            jointFilter.position.y = -0.5; // Pivot noktası
            jointContainer.add(jointFilter);

            // 2. Tütün Kısmı (Kısalacak)
            // Önemli: Pivot noktasını tabana almak için geometry translate ediyoruz
            const bodyGeo = new THREE.CylinderGeometry(CONFIG.joint.radius, CONFIG.joint.radius, 1, 32);
            bodyGeo.translate(0, 0.5, 0); // Pivot en altta (filtrenin ucunda)

            const bodyMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.paper });
            jointBody = new THREE.Mesh(bodyGeo, bodyMat);
            
            // Başlangıç boyunu ayarla
            jointBody.scale.y = CONFIG.joint.length;
            jointBody.position.y = 0; // Filtrenin bittiği yer
            jointContainer.add(jointBody);

            // 3. Köz (Uç)
            const emberGeo = new THREE.SphereGeometry(CONFIG.joint.radius * 0.95, 16, 16);
            const emberMat = new THREE.MeshStandardMaterial({
                color: CONFIG.colors.ash,
                emissive: CONFIG.colors.ember,
                emissiveIntensity: 0
            });
            emberMesh = new THREE.Mesh(emberGeo, emberMat);
            // Pozisyonu update fonksiyonunda ayarlanacak
            jointContainer.add(emberMesh);

            // Işık kaynağı (Köz için)
            const emberLight = new THREE.PointLight(CONFIG.colors.ember, 0, 5);
            emberMesh.add(emberLight); // Köz'e bağla

            jointContainer.visible = false; // Başlangıçta gizli
            scene.add(jointContainer);
        }

        // Duman Dokusu Oluşturucu (Canvas API)
        function generateSmokeTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(64,64,0, 64,64,64);
            grad.addColorStop(0, 'rgba(255,255,255,0.5)');
            grad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,128,128);
            return new THREE.CanvasTexture(canvas);
        }

        // --- 3. OYUN MANTIĞI VE AKIŞ ---

        function startExperience() {
            // UI Geçişi
            document.getElementById('hero-section').style.display = 'none';
            STATE.current = 'ROLLING';
            
            // Sarma UI'ını aç
            const rollingUI = document.getElementById('rolling-ui');
            rollingUI.style.display = 'flex';
            rollingUI.style.opacity = 0;
            gsap.to(rollingUI, { opacity: 1, duration: 1 });

            // Kamera Hareketi
            gsap.to(camera.position, { z: 8, duration: 1.5, ease: "power2.inOut" });
            
            // Yaprağı Yukarı Taşı
            gsap.to(leafGroup.position, { y: 2.5, duration: 1 });
            gsap.to(leafGroup.rotation, { x: 0.5, duration: 1 });
        }

        // SARMA MANTIĞI (Loop içinde çalışır)
        function updateRollingLogic() {
            if (STATE.current !== 'ROLLING') return;

            const bar = document.getElementById('roll-bar');
            const text = document.getElementById('roll-text');

            if (STATE.isRolling) {
                STATE.rollProgress += 0.8; // Dolma hızı
                
                // Efekt: Yaprak titremesi
                leafGroup.rotation.z += (Math.random() - 0.5) * 0.1;
                
                if (STATE.rollProgress >= 100) {
                    STATE.rollProgress = 100;
                    completeRolling();
                }
            } else {
                // Basmıyorsa geri düşsün
                STATE.rollProgress *= 0.95;
            }

            bar.style.width = `${STATE.rollProgress}%`;
            
            // Renk değişimi
            if(STATE.rollProgress > 90) bar.style.backgroundColor = '#fff';
            else bar.style.backgroundColor = 'var(--neon-green)';
        }

        function completeRolling() {
            STATE.current = 'TRANSITION'; // Geçici durum
            
            // UI Temizliği (KESİN ÇÖZÜM)
            const rollingUI = document.getElementById('rolling-ui');
            gsap.to(rollingUI, { opacity: 0, duration: 0.5, onComplete: () => {
                rollingUI.style.display = 'none'; // DOM'dan kaldır
                startSmokingPhase();
            }});

            // Yaprak "sarılıyor" efekti (dönerek küçülme)
            gsap.to(leafGroup.scale, { x: 0, y: 0, z: 0, duration: 0.5 });
            gsap.to(leafGroup.rotation, { z: 10, duration: 0.5 });
        }

        function startSmokingPhase() {
            STATE.current = 'SMOKING';
            
            // İçme UI Göster
            const smokeUI = document.getElementById('smoking-ui');
            smokeUI.style.display = 'block';
            smokeUI.style.opacity = 0;
            gsap.to(smokeUI, { opacity: 1, duration: 1 });

            // Sigarayı Sahneye Getir
            jointContainer.visible = true;
            jointContainer.scale.set(0, 0, 0);
            jointContainer.rotation.z = -Math.PI / 4;
            
            gsap.to(jointContainer.scale, { x: 1, y: 1, z: 1, duration: 1, ease: "elastic.out(1, 0.75)" });

            // Değişkenleri sıfırla
            STATE.currentJointLength = CONFIG.joint.length;
            updateJointVisuals();
        }

        // İÇME MANTIĞI
        function startInhale() {
            STATE.isInhaling = true;
            
            // Kamera Zoom
            gsap.to(camera.position, { z: 6, duration: 0.8 });
            
            // Köz Parlaması
            gsap.to(emberMesh.material, { emissiveIntensity: 2, duration: 0.2 });
            emberMesh.children[0].intensity = 2; // Işık gücü

            // Sigarayı ağza (aşağı) çek
            gsap.to(jointContainer.position, { y: -1, x: 0, duration: 0.5 });
        }

        function stopInhale() {
            if(!STATE.isInhaling) return;
            STATE.isInhaling = false;

            // Kamera Geri
            gsap.to(camera.position, { z: 8, duration: 1 });

            // Köz Sönmesi
            gsap.to(emberMesh.material, { emissiveIntensity: 0, duration: 0.5 });
            emberMesh.children[0].intensity = 0;

            // Sigara Geri
            gsap.to(jointContainer.position, { y: 0, duration: 1 });

            // DUMAN ÜFLEME EFEKTİ
            emitExhaleSmoke();
        }

        function updateBurnLogic() {
            if (STATE.current === 'SMOKING' && STATE.isInhaling) {
                // Sigarayı kısalt
                STATE.currentJointLength -= CONFIG.joint.burnSpeed;
                
                // Eğer bittiyse
                if (STATE.currentJointLength <= 0.2) {
                    STATE.currentJointLength = 0.2;
                    endExperience();
                }

                updateJointVisuals();
                
                // Uçtan çıkan ufak dumanlar
                if(Math.random() > 0.8) createSmokeParticle(false);
            }
        }

        function updateJointVisuals() {
            // Tütün kısmının boyunu güncelle
            jointBody.scale.y = STATE.currentJointLength;
            
            // Közün pozisyonunu güncelle (Tütünün ucu)
            // JointBody position (0) + Scale (Length)
            emberMesh.position.y = STATE.currentJointLength;
        }

        function endExperience() {
            STATE.current = 'END';
            stopInhale(); // Dumanı kes
            
            // UI Temizle
            document.getElementById('smoking-ui').style.display = 'none';
            
            // Son Ekran
            const endScreen = document.getElementById('end-screen');
            endScreen.style.display = 'flex';
            gsap.from(endScreen, { opacity: 0, duration: 2 });
            
            // Sigarayı at
            gsap.to(jointContainer.position, { y: -10, rotationZ: -2, duration: 2 });
        }

        function resetExperience() {
            location.reload(); // En temiz reset yöntemi
        }

        // --- 4. PARÇACIK SİSTEMİ (DUMAN) ---
        function createSmokeParticle(isExhale) {
            const material = new THREE.SpriteMaterial({
                map: smokeTexture,
                color: 0xffffff,
                transparent: true,
                opacity: isExhale ? 0.0 : 0.4,
                rotation: Math.random() * Math.PI
            });

            const sprite = new THREE.Sprite(material);
            
            if (isExhale) {
                // Ekranın altından büyük bulut
                sprite.position.set((Math.random()-0.5)*3, -3, 4);
                sprite.scale.set(2, 2, 2);
                sprite.userData = {
                    velocity: new THREE.Vector3(0, 0.05, 0),
                    life: 1.0,
                    decay: 0.005,
                    growth: 0.05,
                    isExhale: true
                };
            } else {
                // Sigara ucundan ince duman
                // Közün dünya koordinatını al
                const vector = new THREE.Vector3();
                emberMesh.getWorldPosition(vector);
                
                sprite.position.copy(vector);
                sprite.position.x += (Math.random()-0.5)*0.1;
                
                sprite.scale.set(0.5, 0.5, 0.5);
                sprite.userData = {
                    velocity: new THREE.Vector3((Math.random()-0.5)*0.02, 0.03, 0),
                    life: 1.0,
                    decay: 0.01,
                    growth: 0.01,
                    isExhale: false
                };
            }

            scene.add(sprite);
            smokeParticles.push(sprite);
        }

        function emitExhaleSmoke() {
            for(let i=0; i<30; i++) {
                setTimeout(() => createSmokeParticle(true), i * 30);
            }
        }

        function updateParticles() {
            for (let i = smokeParticles.length - 1; i >= 0; i--) {
                const p = smokeParticles[i];
                const data = p.userData;

                p.position.add(data.velocity);
                p.scale.addScalar(data.growth);
                p.rotation.z += 0.005;
                data.life -= data.decay;

                // Opaklık Efekti (Fade In / Fade Out)
                if (data.isExhale) {
                    // Nefes verirken önce belirginleşir sonra kaybolur
                    if (data.life > 0.8) p.material.opacity = (1 - data.life) * 2; // Fade in
                    else p.material.opacity = data.life * 0.5; // Fade out
                } else {
                    p.material.opacity = data.life * 0.3;
                }

                if (data.life <= 0) {
                    scene.remove(p);
                    smokeParticles.splice(i, 1);
                }
            }
        }

        // --- 5. RENDER DÖNGÜSÜ ---
        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now() * 0.001;

            // Mantık Güncellemeleri
            updateRollingLogic();
            updateBurnLogic();
            updateParticles();

            // Animasyonlar
            if (STATE.current === 'INTRO') {
                leafGroup.rotation.y = Math.sin(time * 0.5) * 0.5;
                leafGroup.rotation.z = Math.cos(time * 0.3) * 0.1;
            } else if (STATE.current === 'SMOKING') {
                // Sigara fareyi takip etsin (hafif gecikmeli)
                jointContainer.rotation.z = THREE.MathUtils.lerp(jointContainer.rotation.z, -Math.PI/4 + (-mouse.x * 0.3), 0.1);
                jointContainer.rotation.x = THREE.MathUtils.lerp(jointContainer.rotation.x, -mouse.y * 0.3, 0.1);
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        // Başlat
        init();

    </script>
</body>
</html>
