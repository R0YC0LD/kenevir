<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SATIVA REALISM | HIGH FIDELITY</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00ff88; /* Vurgu rengi */
            --skin: #d4a063; /* Ten rengi */
            --ember: #ff3300; /* Kor rengi */
            --ash: #333333; /* Kül rengi */
            --bg: #0a0a0a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-drag: none; cursor: crosshair; }

        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        #webgl-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* UI KATMANI */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 30px;
        }

        .interactive { pointer-events: auto; }

        /* HEADER */
        header { text-align: center; text-transform: uppercase; letter-spacing: 3px; }
        h1 { font-weight: 900; font-size: 2.5rem; background: linear-gradient(to right, var(--primary), #00aaff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #phase-display { font-weight: 700; color: #666; margin-top: 10px; }

        /* TALİMATLAR */
        #instruction-box {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 20px 40px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            text-align: center;
        }
        #instruction-text { font-size: 1.2rem; font-weight: 700; }
        .key { color: var(--bg); background: var(--primary); padding: 3px 10px; border-radius: 5px; margin: 0 5px; box-shadow: 0 0 10px var(--primary); }

        /* GİRİŞ EKRANI */
        #intro-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(10,10,10,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .start-btn {
            margin-top: 40px; padding: 20px 50px; font-size: 1.5rem; font-weight: 900;
            background: var(--primary); color: var(--bg); border: none; border-radius: 50px;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .start-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px var(--primary); }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index: 999; display: flex; justify-content: center; align-items: center; color: var(--primary); font-weight: 900; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="loader">SİSTEM YÜKLENİYOR...</div>
    <div id="webgl-container"></div>

    <div id="ui-layer">
        <header>
            <h1>SATIVA REALISM</h1>
            <div id="phase-display">BEKLEMEDE</div>
        </header>

        <div id="intro-screen" class="interactive">
            <h1 style="font-size: 4rem;">ORGANİK DENEYİM</h1>
            <p style="color:#888; margin-top: 20px;">Gerçekçi Fizik & İnsan Etkileşimi</p>
            <button class="start-btn" onclick="startExperience()">BAŞLAT</button>
        </div>

        <div id="instruction-box" style="display:none;">
            <div id="instruction-text">TALİMATLAR</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- AYARLAR ---
        const CONFIG = {
            colors: {
                bg: 0x0a0a0a,
                skin: 0xd4a063, // Gerçekçi ten rengi
                paper: 0xf0f0f0,
                ember: 0xff4400,
                ash: 0x555555,
                smoke: 0xeeeeee
            },
            jointLength: 3.5,
            jointRadius: 0.14
        };

        const STATE = {
            phase: 'INIT',
            progress: 0,
            isMouseDown: false,
            isSpaceDown: false,
            mouse: new THREE.Vector2(),
            jointScaleY: 1.0 // Sigaranın anlık boyu
        };

        let scene, camera, renderer, clock;
        let handsLeft, handsRight, paperGroup, mixParticles;
        let jointGroup, jointBody, jointEmber, jointAsh, emberLight;
        let lighterGroup, lighterFlame;
        let smokeParticles = [];
        let smokeTexture;
        
        // --- 1. BAŞLATMA ---
        function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.bg);
            scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.015);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 4, 12);
            camera.lookAt(0, 1, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            document.getElementById('webgl-container').appendChild(renderer.domElement);

            setupLights();
            smokeTexture = createSmokeTexture();
            createObjects();
            setupInputs();

            document.getElementById('loader').style.display = 'none';
            animate();
        }

        function setupLights() {
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);

            const mainSpot = new THREE.SpotLight(0xffeeb1, 1.2); // Sıcak güneş ışığı
            mainSpot.position.set(5, 15, 10);
            mainSpot.castShadow = true;
            mainSpot.shadow.bias = -0.0001;
            mainSpot.shadow.mapSize.width = 2048;
            mainSpot.shadow.mapSize.height = 2048;
            scene.add(mainSpot);

            // Yumuşak dolgu ışıkları (Ten rengini ortaya çıkarmak için)
            const fillLight = new THREE.PointLight(0xffdcb4, 0.5);
            fillLight.position.set(-5, 2, 5);
            scene.add(fillLight);
        }

        // --- 2. OBJE OLUŞTURMA (ORGANİK & GERÇEKÇİ) ---

        function createObjects() {
            createRealisticHands();
            createRollingPaper();
            createDetailedJoint();
            createLighter();
        }

        // GERÇEKÇİ İNSAN ELLERİ (Procedural Organic Hands)
        function createRealisticHands() {
            // Ten Materyali (Skin Material)
            const skinMat = new THREE.MeshStandardMaterial({
                color: CONFIG.colors.skin,
                roughness: 0.6, // Hafif pürüzlü
                metalness: 0.0,
                side: THREE.DoubleSide
            });

            function buildHumanHand(isLeft) {
                const handGroup = new THREE.Group();
                
                // Avuç İçi (Palm) - Yassılaştırılmış Küre
                const palmGeo = new THREE.SphereGeometry(1.2, 32, 32);
                palmGeo.scale(1, 0.8, 0.4);
                const palm = new THREE.Mesh(palmGeo, skinMat);
                palm.castShadow = true;
                handGroup.add(palm);

                // Parmaklar (Fingers) - Silindirler ve Eklemler
                const fingerPositions = [-0.9, -0.3, 0.3, 0.9]; // X offsetleri
                const fingerLengths = [1.2, 1.4, 1.3, 1.0]; // Parmak uzunlukları

                fingerPositions.forEach((xPos, i) => {
                    const fingerGroup = new THREE.Group();
                    fingerGroup.position.set(xPos, 0.6, 0);

                    // Alt Boğum
                    const seg1Geo = new THREE.CylinderGeometry(0.18, 0.2, fingerLengths[i]*0.5, 16);
                    const seg1 = new THREE.Mesh(seg1Geo, skinMat);
                    seg1.position.y = fingerLengths[i]*0.25;
                    seg1.castShadow = true;
                    
                    // Üst Boğum (Hafif kıvrık)
                    const seg2Geo = new THREE.CylinderGeometry(0.16, 0.18, fingerLengths[i]*0.5, 16);
                    const seg2 = new THREE.Mesh(seg2Geo, skinMat);
                    seg2.position.y = fingerLengths[i]*0.75;
                    seg2.rotation.x = -0.2; // Doğal kıvrım
                    seg2.castShadow = true;

                    fingerGroup.add(seg1, seg2);
                    handGroup.add(fingerGroup);
                });

                // Başparmak (Thumb)
                const thumbGroup = new THREE.Group();
                thumbGroup.position.set(isLeft ? 1.0 : -1.0, -0.2, 0.3);
                thumbGroup.rotation.z = isLeft ? -0.8 : 0.8;
                thumbGroup.rotation.y = isLeft ? 0.5 : -0.5;

                const thumbGeo = new THREE.CylinderGeometry(0.22, 0.25, 1.2, 16);
                const thumb = new THREE.Mesh(thumbGeo, skinMat);
                thumb.position.y = 0.6;
                thumb.castShadow = true;
                thumbGroup.add(thumb);
                handGroup.add(thumbGroup);

                return handGroup;
            }

            handsLeft = buildHumanHand(true);
            handsRight = buildHumanHand(false);
            
            // Başlangıçta gizle ve pozisyonla
            handsLeft.position.set(-5, -5, 2);
            handsLeft.rotation.y = Math.PI / 4;
            
            handsRight.position.set(5, -5, 2);
            handsRight.rotation.y = -Math.PI / 4;

            scene.add(handsLeft, handsRight);
        }

        function createRollingPaper() {
            paperGroup = new THREE.Group();

            const paperGeo = new THREE.PlaneGeometry(4, 2.8);
            const paperMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.paper, side: THREE.DoubleSide, roughness: 0.8 });
            const paper = new THREE.Mesh(paperGeo, paperMat);
            paper.rotation.x = -Math.PI / 2;
            paper.receiveShadow = true;
            paperGroup.add(paper);

            // Karışım (Mix Particles)
            const pGeo = new THREE.BufferGeometry();
            const pPos = [];
            for(let i=0; i<600; i++) {
                pPos.push((Math.random()-0.5)*3.5, Math.random()*0.15, (Math.random()-0.5)*1.8);
            }
            pGeo.setAttribute('position', new THREE.Float32BufferAttribute(pPos, 3));
            mixParticles = new THREE.Points(pGeo, new THREE.PointsMaterial({ color: 0x3a6b35, size: 0.06 }));
            paperGroup.add(mixParticles);

            paperGroup.visible = false;
            scene.add(paperGroup);
        }

        // DETAYLI SİGARA VE KÖZ SİSTEMİ (Havada durma sorununu çözer)
        function createDetailedJoint() {
            jointGroup = new THREE.Group();

            // Gövde (Kağıt kısmı) - Pivot noktası en altta
            const bodyGeo = new THREE.CylinderGeometry(CONFIG.jointRadius, CONFIG.jointRadius*0.9, CONFIG.jointLength, 32);
            bodyGeo.translate(0, CONFIG.jointLength / 2, 0); // Pivot'u tabana al
            
            const bodyMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.paper, roughness: 0.9 });
            jointBody = new THREE.Mesh(bodyGeo, bodyMat);
            jointBody.castShadow = true;
            jointGroup.add(jointBody);

            // Köz ve Kül Grubu (Ember & Ash)
            jointEmber = new THREE.Group();
            
            // Yanan Kor (Glowing Ember)
            const emberGeo = new THREE.SphereGeometry(CONFIG.jointRadius * 0.95, 16, 16);
            const emberMat = new THREE.MeshStandardMaterial({
                color: 0x111111,
                emissive: CONFIG.colors.ember,
                emissiveIntensity: 0, // Başlangıçta sönük
                roughness: 1
            });
            const emberMesh = new THREE.Mesh(emberGeo, emberMat);
            jointEmber.add(emberMesh);

            // Kül Ucu (Ash Tip) - Korun üzerinde duracak
            const ashGeo = new THREE.CylinderGeometry(CONFIG.jointRadius*0.9, CONFIG.jointRadius*0.8, 0.15, 16);
            const ashMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.ash, roughness: 1 });
            jointAsh = new THREE.Mesh(ashGeo, ashMat);
            jointAsh.position.y = 0.08; // Korun biraz üstü
            jointEmber.add(jointAsh);

            // Kor Işığı (Ember Light)
            emberLight = new THREE.PointLight(CONFIG.colors.ember, 0, 4);
            emberLight.position.y = 0.1;
            jointEmber.add(emberLight);

            // Közü başlangıçta sigaranın tepesine yerleştir
            jointEmber.position.y = CONFIG.jointLength;
            jointGroup.add(jointEmber);

            jointGroup.visible = false;
            scene.add(jointGroup);
        }

        function createLighter() {
            lighterGroup = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1, 2.5, 0.5), new THREE.MeshStandardMaterial({color: 0x222222, metalness:0.6}));
            lighterGroup.add(body);

            const flameGeo = new THREE.ConeGeometry(0.15, 0.5, 16);
            const flameMat = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
            lighterFlame = new THREE.Mesh(flameGeo, flameMat);
            lighterFlame.position.y = 1.5;
            lighterFlame.visible = false;
            lighterFlame.add(new THREE.PointLight(0xffaa00, 1.5, 5));
            lighterGroup.add(lighterFlame);

            lighterGroup.visible = false;
            scene.add(lighterGroup);
        }

        // --- 3. OYUN AKIŞI VE ANİMASYONLAR ---

        window.startExperience = function() {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('instruction-box').style.display = 'block';
            startRollPhase();
        };

        function setPhase(text) { document.getElementById('phase-display').innerText = text; }
        function setInstruction(html) { document.getElementById('instruction-text').innerHTML = html; }

        // FAZ 1: SARMA (ROLLING)
        function startRollPhase() {
            STATE.phase = 'ROLL';
            setPhase('AŞAMA: SARMA');
            setInstruction('SARMAK İÇİN <span class="key">BOŞLUK (SPACE)</span> BASILI TUT');

            paperGroup.visible = true;
            paperGroup.position.y = -2;
            gsap.to(paperGroup.position, { y: 0.5, duration: 1, ease: 'back.out' });

            // Organik eller belirsin
            gsap.to(handsLeft.position, { x: -2.5, y: 0.5, z: 1, duration: 1.2, ease: 'power2.out' });
            gsap.to(handsRight.position, { x: 2.5, y: 0.5, z: 1, duration: 1.2, ease: 'power2.out' });
            gsap.to(handsLeft.rotation, { y: 0.2, z: -0.2, duration: 1.2 });
            gsap.to(handsRight.rotation, { y: -0.2, z: 0.2, duration: 1.2 });
        }

        function updateRollLogic() {
            STATE.progress += 0.7;
            const normProgress = STATE.progress / 100;

            // Eller birleşiyor ve dönüyor (Daha doğal hareket)
            handsLeft.position.x = THREE.MathUtils.lerp(-2.5, -0.8, normProgress);
            handsRight.position.x = THREE.MathUtils.lerp(2.5, 0.8, normProgress);
            handsLeft.rotation.z = THREE.MathUtils.lerp(-0.2, -0.8, normProgress);
            handsRight.rotation.z = THREE.MathUtils.lerp(0.2, 0.8, normProgress);

            // Kağıt kıvrılıyor
            paperGroup.scale.x = 1 - (normProgress * 0.8);
            paperGroup.rotation.x = -Math.PI / 2 + (normProgress * 0.5);
            
            // Karışım toplanıyor
            const positions = mixParticles.geometry.attributes.position.array;
            for(let i=0; i<positions.length; i+=3) positions[i] *= 0.97;
            mixParticles.geometry.attributes.position.needsUpdate = true;

            if(STATE.progress >= 100) {
                STATE.phase = 'TRANSITION';
                // Eller ve kağıt gitsin
                gsap.to(handsLeft.position, { y: -5, duration: 0.8 });
                gsap.to(handsRight.position, { y: -5, duration: 0.8 });
                gsap.to(paperGroup.scale, { x:0, y:0, z:0, duration: 0.5 });
                setTimeout(startLightPhase, 1000);
            }
        }

        // FAZ 2: YAKMA (LIGHTING)
        function startLightPhase() {
            STATE.phase = 'LIGHT';
            STATE.progress = 0;
            setPhase('AŞAMA: YAKMA');
            setInstruction('ÇAKMAK İÇİN <span class="key">SOL TIK</span> BASILI TUTUP UCUNA TUT');

            paperGroup.visible = false;
            
            jointGroup.visible = true;
            jointGroup.position.set(-2, 0.5, 0);
            jointGroup.rotation.set(0, 0, -0.5);
            
            lighterGroup.visible = true;
            lighterGroup.position.set(2, -1, 0);
            
            // Sigara belirsin
            gsap.from(jointGroup.scale, { x:0, y:0, z:0, duration: 1, ease:'elastic.out' });
        }

        function updateLightLogic() {
            if(STATE.isMouseDown) {
                lighterFlame.visible = true;
                // Çakmak mouse'u takip etsin (3D projeksiyon basitleştirilmiş)
                lighterGroup.position.x = THREE.MathUtils.lerp(lighterGroup.position.x, STATE.mouse.x * 5, 0.1);
                lighterGroup.position.y = THREE.MathUtils.lerp(lighterGroup.position.y, STATE.mouse.y * 5, 0.1);

                // Mesafe kontrolü
                const tipPos = new THREE.Vector3();
                jointEmber.getWorldPosition(tipPos);
                const flamePos = new THREE.Vector3();
                lighterFlame.getWorldPosition(flamePos);

                if(tipPos.distanceTo(flamePos) < 1.2) {
                    STATE.progress += 1.5;
                    // Köz kızarmaya başlasın
                    const intensity = STATE.progress / 100;
                    jointEmber.children[0].material.emissiveIntensity = intensity * 2;
                    emberLight.intensity = intensity * 2;

                    if(STATE.progress >= 100) {
                        STATE.phase = 'TRANSITION';
                        gsap.to(lighterGroup.position, { y: -5, duration: 0.5 });
                        setTimeout(startSmokePhase, 800);
                    }
                }
            } else {
                lighterFlame.visible = false;
            }
        }

        // FAZ 3: İÇME (SMOKING) - KRİTİK DÜZELTMELER BURADA
        function startSmokePhase() {
            STATE.phase = 'SMOKE';
            setPhase('AŞAMA: İÇİM');
            setInstruction('<span class="key">SOL TIK</span> İÇİNE ÇEK | <span class="key">BIRAK</span> DUMANI ÜFLE');
            
            lighterGroup.visible = false;

            // Sigarayı içim pozisyonuna getir
            gsap.to(jointGroup.position, { x: 0, y: -1.5, z: 3, duration: 1.5, ease:'power2.inOut' });
            gsap.to(jointGroup.rotation, { x: Math.PI / 2.2, y: 0, z: 0, duration: 1.5, ease:'power2.inOut' });
        }

        function updateSmokeLogic(delta) {
            // Fare ile hafif dönüş
            if(STATE.phase === 'SMOKE' && jointGroup) {
                jointGroup.rotation.y = STATE.mouse.x * 0.3;
                jointGroup.rotation.x = Math.PI / 2.2 - STATE.mouse.y * 0.2;
            }

            if(STATE.isMouseDown) {
                // İÇİNE ÇEKME (INHALE)
                // Kamera zoom
                camera.position.z = THREE.MathUtils.lerp(camera.position.z, 9, 0.05);
                
                // Köz parlaklığı artar
                jointEmber.children[0].material.emissiveIntensity = THREE.MathUtils.lerp(jointEmber.children[0].material.emissiveIntensity, 4.0, 0.1);
                emberLight.intensity = THREE.MathUtils.lerp(emberLight.intensity, 3.0, 0.1);

                // SİGARA KISALMASI VE KÖZ HAREKETİ (Havada durma sorununu çözer)
                STATE.jointScaleY -= 0.002 * delta * 60; // Hız ayarı
                if(STATE.jointScaleY < 0.15) STATE.jointScaleY = 0.15; // Minimum boy

                // 1. Gövdeyi kısalt (Scale Y)
                jointBody.scale.y = STATE.jointScaleY;
                
                // 2. Közü yeni tepe noktasına taşı (Burası kilit nokta)
                // Yeni pozisyon = Başlangıç Boyu * Anlık Ölçek
                jointEmber.position.y = CONFIG.jointLength * STATE.jointScaleY;

                // Uçtan hafif duman çıksın
                if(Math.random()>0.7) createSmoke(false);

            } else {
                // BOŞTA / ÜFLEME (EXHALE/IDLE)
                camera.position.z = THREE.MathUtils.lerp(camera.position.z, 12, 0.05);
                // Köz sönükleşir
                jointEmber.children[0].material.emissiveIntensity = THREE.MathUtils.lerp(jointEmber.children[0].material.emissiveIntensity, 0.8, 0.1);
                emberLight.intensity = THREE.MathUtils.lerp(emberLight.intensity, 0.5, 0.1);
            }
        }

        // --- EFEKTLER & GİRDİLER ---

        function createSmokeTexture() {
            const c = document.createElement('canvas'); c.width=128; c.height=128;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(64,64,0,64,64,64);
            g.addColorStop(0,'rgba(255,255,255,0.3)');
            g.addColorStop(0.4,'rgba(200,200,200,0.1)');
            g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,128,128);
            return new THREE.CanvasTexture(c);
        }

        function createSmoke(isExhale) {
            const mat = new THREE.SpriteMaterial({ map: smokeTexture, color: CONFIG.colors.smoke, transparent: true, opacity: 0, rotation: Math.random()*Math.PI });
            const sprite = new THREE.Sprite(mat);
            
            if(isExhale) {
                // Ağızdan çıkan yoğun duman
                sprite.position.set((Math.random()-0.5)*2, -3, 6);
                sprite.scale.set(0.5,0.5,0.5);
                sprite.userData = { vel: new THREE.Vector3(0, 0.08, 0), life: 1.0, growth: 0.08, maxOp: 0.5 };
            } else {
                // Sigara ucundan çıkan ince duman
                const tipPos = new THREE.Vector3();
                jointEmber.getWorldPosition(tipPos);
                sprite.position.copy(tipPos);
                sprite.scale.set(0.3,0.3,0.3);
                sprite.userData = { vel: new THREE.Vector3((Math.random()-0.5)*0.02, 0.04, 0), life: 1.0, growth: 0.02, maxOp: 0.2 };
            }
            scene.add(sprite);
            smokeParticles.push(sprite);
        }

        function updateSmokeParticles(delta) {
            for(let i=smokeParticles.length-1; i>=0; i--) {
                const p = smokeParticles[i];
                p.position.add(p.userData.vel.clone().multiplyScalar(delta*60));
                p.scale.addScalar(p.userData.growth * delta*60);
                p.rotation.z += 0.01 * delta*60; // Dönüş efekti
                
                p.userData.life -= 0.008 * delta*60;
                
                // Fade in / out mantığı
                if(p.userData.life > 0.8) {
                     p.material.opacity = (1 - p.userData.life) * 5 * p.userData.maxOp;
                } else {
                     p.material.opacity = p.userData.life * p.userData.maxOp;
                }

                if(p.userData.life <= 0) {
                    scene.remove(p);
                    smokeParticles.splice(i,1);
                }
            }
        }

        function setupInputs() {
            window.addEventListener('mousemove', (e) => {
                STATE.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                STATE.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            });
            window.addEventListener('mousedown', () => STATE.isMouseDown = true);
            window.addEventListener('mouseup', () => {
                STATE.isMouseDown = false;
                if(STATE.phase === 'SMOKE') {
                    // Nefes ver (Exhale)
                    for(let i=0; i<20; i++) setTimeout(() => createSmoke(true), i*30);
                }
            });
            window.addEventListener('keydown', (e) => { if(e.code === 'Space') STATE.isSpaceDown = true; });
            window.addEventListener('keyup', (e) => { if(e.code === 'Space') STATE.isSpaceDown = false; });
        }

        // --- ANA DÖNGÜ ---
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if(STATE.phase === 'ROLL' && STATE.isSpaceDown) updateRollLogic();
            if(STATE.phase === 'LIGHT') updateLightLogic();
            if(STATE.phase === 'SMOKE') updateSmokeLogic(delta);
            
            updateSmokeParticles(delta);

            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
