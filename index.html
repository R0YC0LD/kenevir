<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SATIVA UNIVERSE | STABLE MEGA EDITION</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00ff88;
            --secondary: #00aaff;
            --danger: #ff3300;
            --bg: #050505;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-drag: none; cursor: crosshair; }

        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        #webgl-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* UI KATMANI */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }

        .interactive { pointer-events: auto; }

        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: flex-start;
            text-shadow: 0 0 10px var(--primary);
        }
        h1 {
            font-family: 'Black Ops One', cursive; font-size: 3rem; color: transparent;
            -webkit-text-stroke: 1px var(--primary); letter-spacing: 5px;
        }
        .status-box {
            text-align: right;
            border: 1px solid var(--primary); padding: 10px;
            background: rgba(0, 255, 136, 0.1);
        }

        /* GÖREV ÇUBUĞU */
        #task-bar {
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%);
            text-align: center; width: 80%;
        }
        .task-text {
            font-size: 1.5rem; background: rgba(0,0,0,0.8); padding: 15px 30px;
            border: 1px solid var(--secondary); border-radius: 5px; display: inline-block;
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.3); animation: pulse 2s infinite;
        }
        .key { color: var(--primary); font-weight: bold; border: 1px solid var(--primary); padding: 0 10px; margin: 0 5px; }

        /* SEÇİM EKRANI */
        #intro-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(5,5,5,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .card-container { display: flex; gap: 30px; margin-top: 50px; }
        .strain-card {
            width: 250px; height: 350px; background: rgba(255,255,255,0.05);
            border: 2px solid #333; padding: 20px; cursor: pointer;
            transition: 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .strain-card:hover { border-color: var(--primary); background: rgba(0, 255, 136, 0.1); transform: translateY(-10px); }
        
        /* PROGRESS BAR */
        #progress-container {
            position: absolute; bottom: 5%; left: 0; width: 100%; height: 5px; background: #333;
        }
        #progress-fill { width: 0%; height: 100%; background: var(--primary); transition: width 0.1s; box-shadow: 0 0 10px var(--primary); }

        @keyframes pulse { 0% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.02); } 100% { opacity: 0.8; transform: scale(1); } }

        /* KÜTÜPHANE YÜKLEME EKRANI */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background:black;
            z-index: 999; display: flex; justify-content: center; align-items: center; color: var(--primary);
            font-family: 'Black Ops One'; font-size: 2rem;
        }
    </style>
</head>
<body>

    <div id="loader">MOTOR BAŞLATILIYOR...</div>
    <div id="webgl-container"></div>

    <div id="ui-layer">
        <header>
            <h1>SATIVA<br><span style="font-size:1.5rem; color:white; -webkit-text-stroke:0;">UNIVERSE</span></h1>
            <div class="status-box">
                <div id="phase-display">BEKLEMEDE</div>
                <div id="fps-display">FPS: 60</div>
            </div>
        </header>

        <div id="intro-screen" class="interactive">
            <h2 style="font-family:'Black Ops One'; font-size:3rem;">GENETİK SEÇİMİ</h2>
            <p style="color:#aaa;">SİMÜLASYONA BAŞLAMAK İÇİN TÜR SEÇİN</p>
            
            <div class="card-container">
                <div class="strain-card" onclick="startSim('INDICA')">
                    <h3 style="color:#a0f; font-size:2rem; margin-bottom:10px;">PURPLE KUSH</h3>
                    <p>Derin gevşeme, Mor tonlar, Tatlı aroma.</p>
                </div>
                <div class="strain-card" onclick="startSim('SATIVA')">
                    <h3 style="color:#ff0; font-size:2rem; margin-bottom:10px;">LEMON HAZE</h3>
                    <p>Enerji, Neon sarı, Limon aroması.</p>
                </div>
                <div class="strain-card" onclick="startSim('HYBRID')">
                    <h3 style="color:#0f8; font-size:2rem; margin-bottom:10px;">GORILLA GLUE</h3>
                    <p>Dengeli etki, Çam yeşili, Güçlü yapı.</p>
                </div>
            </div>
        </div>

        <div id="task-bar" style="display:none;">
            <div class="task-text" id="instruction-text">TALİMATLAR</div>
        </div>

        <div id="progress-container"><div id="progress-fill"></div></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- MOTOR AYARLARI ---
        const CONFIG = {
            colors: {
                bg: 0x050505,
                primary: 0x00ff88,
                fire: 0xff4400,
                smoke: 0xeeeeee
            },
            strain: 'HYBRID'
        };

        const STATE = {
            phase: 'INIT', // INIT, GRIND, ROLL, LIGHT, SMOKE, DONE
            progress: 0,
            active: false,
            clicks: 0, // Öğütme için
            mouse: new THREE.Vector2(),
            isMouseDown: false
        };

        let scene, camera, renderer;
        let grinder, handsLeft, handsRight, paper, mixParticles;
        let joint, lighter, flame;
        let smokeParticles = [];
        
        // --- 1. SİSTEM BAŞLATMA ---
        function init() {
            // Sahne
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.bg);
            scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.02);

            // Kamera
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);

            // Render
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            document.getElementById('webgl-container').appendChild(renderer.domElement);

            // Işıklar
            const amb = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(amb);
            const spot = new THREE.SpotLight(0xffffff, 1.5);
            spot.position.set(5, 10, 5);
            spot.castShadow = true;
            scene.add(spot);
            
            // Neon Işıklar
            const p1 = new THREE.PointLight(0x00ff88, 0.5); p1.position.set(-5, 2, 0); scene.add(p1);
            const p2 = new THREE.PointLight(0x00aaff, 0.5); p2.position.set(5, 2, 0); scene.add(p2);

            // Eventler
            window.addEventListener('resize', onResize);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mousedown', () => STATE.isMouseDown = true);
            window.addEventListener('mouseup', () => STATE.isMouseDown = false);

            // Input İşleyicileri
            setupInputs();

            // Yükleme Ekranını Kapat
            document.getElementById('loader').style.display = 'none';

            animate();
        }

        // --- 2. OBJE OLUŞTURUCULAR (Güvenli Geometriler) ---

        function createGrinder() {
            const group = new THREE.Group();
            
            // Alt
            const baseGeo = new THREE.CylinderGeometry(1.5, 1.5, 0.8, 32);
            const mat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.3, metalness: 0.8 });
            const base = new THREE.Mesh(baseGeo, mat);
            group.add(base);

            // Üst (Kapak)
            const topGeo = new THREE.CylinderGeometry(1.55, 1.55, 0.4, 32);
            const top = new THREE.Mesh(topGeo, mat);
            top.position.y = 0.6;
            top.userData = { isTop: true }; // Tanımlayıcı
            group.add(top);

            // İçerik (Ot)
            const weedGeo = new THREE.DodecahedronGeometry(0.8);
            const weedMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.primary, wireframe: false });
            const weed = new THREE.Mesh(weedGeo, weedMat);
            weed.position.y = 0.4;
            weed.scale.set(0.8, 0.8, 0.8);
            weed.visible = false; // Başta gizli
            group.userData = { weed: weed };
            group.add(weed);

            return group;
        }

        function createHands() {
            // Cyber Eller (Basit Bloklar)
            const mat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.2 });
            const wire = new THREE.MeshBasicMaterial({ color: CONFIG.colors.primary, wireframe: true });
            
            function buildHand() {
                const g = new THREE.Group();
                const palm = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.5, 2), mat);
                palm.add(new THREE.Mesh(new THREE.BoxGeometry(1.52, 0.52, 2.02), wire));
                g.add(palm);
                // Parmaklar
                for(let i=0; i<4; i++){
                    const f = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 1), mat);
                    f.position.set((i-1.5)*0.4, 0, 1.5);
                    g.add(f);
                }
                return g;
            }

            handsLeft = buildHand();
            handsRight = buildHand();
            handsLeft.position.set(-10, 0, 0); // Ekran dışı
            handsRight.position.set(10, 0, 0);
            
            scene.add(handsLeft);
            scene.add(handsRight);
        }

        function createRollingPaper() {
            paper = new THREE.Mesh(
                new THREE.PlaneGeometry(3.5, 2.5),
                new THREE.MeshStandardMaterial({ color: 0xffffff, side: THREE.DoubleSide })
            );
            paper.rotation.x = -Math.PI / 2;
            paper.visible = false;
            scene.add(paper);

            // Karışım (Particles)
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<300; i++) {
                pos.push((Math.random()-0.5)*3, Math.random()*0.2, (Math.random()-0.5)*1.5);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            mixParticles = new THREE.Points(
                geo,
                new THREE.PointsMaterial({ color: CONFIG.colors.primary, size: 0.08 })
            );
            mixParticles.visible = false;
            scene.add(mixParticles);
        }

        function createJoint() {
            const group = new THREE.Group();
            
            // Dal
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.12, 3.5, 32),
                new THREE.MeshStandardMaterial({ color: 0xffffff })
            );
            body.rotation.z = Math.PI / 2;
            group.add(body);

            // Uç (Köz)
            const tip = new THREE.Mesh(
                new THREE.SphereGeometry(0.14, 16, 16),
                new THREE.MeshStandardMaterial({ color: 0x222222, emissive: 0xff3300, emissiveIntensity: 0 })
            );
            tip.position.x = 1.75;
            tip.userData = { isEmber: true };
            
            // Işık (Ember Light)
            const light = new THREE.PointLight(0xff4400, 0, 3);
            tip.add(light);
            
            group.add(tip);
            
            group.visible = false;
            joint = group;
            scene.add(joint);
        }

        function createLighter() {
            lighter = new THREE.Group();
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 2.2, 0.4),
                new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.5 })
            );
            lighter.add(body);
            
            // Alev
            const fGeo = new THREE.ConeGeometry(0.15, 0.6, 16);
            const fMat = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
            flame = new THREE.Mesh(fGeo, fMat);
            flame.position.y = 1.4;
            flame.visible = false;
            
            const fLight = new THREE.PointLight(0xffaa00, 1, 4);
            flame.add(fLight);
            
            lighter.add(flame);
            lighter.visible = false;
            scene.add(lighter);
        }

        // --- 3. OYUN AKIŞI ---

        window.startSim = function(type) {
            CONFIG.strain = type;
            if(type === 'INDICA') CONFIG.colors.primary = 0x8800ff;
            if(type === 'SATIVA') CONFIG.colors.primary = 0xffff00;
            
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('task-bar').style.display = 'block';

            // Objeleri Yarat
            grinder = createGrinder();
            scene.add(grinder);
            createHands();
            createRollingPaper();
            createJoint();
            createLighter();

            startGrindPhase();
        };

        function setInstruction(text) {
            document.getElementById('instruction-text').innerHTML = text;
        }

        function updateProgress(val) {
            document.getElementById('progress-fill').style.width = val + '%';
        }

        // FAZ 1: ÖĞÜTME
        function startGrindPhase() {
            STATE.phase = 'GRIND';
            STATE.clicks = 0;
            STATE.progress = 0;
            
            grinder.position.set(0, -5, 0);
            gsap.to(grinder.position, { y: 0, duration: 1, ease: 'back.out' });
            
            setInstruction('ÖĞÜTMEK İÇİN <span class="key">TIKLA</span> (HIZLICA)');
        }

        function handleGrindClick() {
            STATE.clicks++;
            STATE.progress = (STATE.clicks / 20) * 100; // 20 Tıklama gerekli
            
            // Animasyon
            grinder.children[1].rotation.y += 0.5; // Kapağı döndür
            grinder.rotation.z = (Math.random()-0.5)*0.2; // Sallanma
            
            updateProgress(STATE.progress);

            if(STATE.progress >= 100) {
                STATE.phase = 'TRANSITION';
                gsap.to(grinder.position, { y: -10, duration: 0.5 });
                setTimeout(startRollPhase, 600);
            }
        }

        // FAZ 2: SARMA
        function startRollPhase() {
            STATE.phase = 'ROLL';
            STATE.progress = 0;
            updateProgress(0);
            
            paper.visible = true;
            mixParticles.visible = true;
            paper.position.y = -2;
            gsap.to(paper.position, { y: 0, duration: 0.5 });

            // Eller gelsin
            gsap.to(handsLeft.position, { x: -2.5, duration: 1 });
            gsap.to(handsRight.position, { x: 2.5, duration: 1 });

            setInstruction('SARMAK İÇİN <span class="key">BOŞLUK (SPACE)</span> BASILI TUT');
        }

        function updateRollLogic() {
            STATE.progress += 0.5; // Hızlı dolum
            updateProgress(STATE.progress);

            // Eller birleşiyor
            handsLeft.position.x = THREE.MathUtils.lerp(-2.5, -0.5, STATE.progress/100);
            handsRight.position.x = THREE.MathUtils.lerp(2.5, 0.5, STATE.progress/100);
            
            // Kağıt kıvrılıyor (scale hilesi)
            paper.scale.x = 1 - (STATE.progress/150);
            
            // Particles toplanıyor
            const pos = mixParticles.geometry.attributes.position.array;
            for(let i=0; i<pos.length; i+=3) pos[i] *= 0.98;
            mixParticles.geometry.attributes.position.needsUpdate = true;

            if(STATE.progress >= 100) {
                STATE.phase = 'TRANSITION';
                // Temizlik
                gsap.to(handsLeft.position, { x: -10, duration: 0.5 });
                gsap.to(handsRight.position, { x: 10, duration: 0.5 });
                paper.visible = false;
                mixParticles.visible = false;
                
                setTimeout(startLightPhase, 500);
            }
        }

        // FAZ 3: YAKMA
        function startLightPhase() {
            STATE.phase = 'LIGHT';
            STATE.progress = 0;
            updateProgress(0);

            joint.visible = true;
            joint.position.set(-2, 0, 0);
            
            lighter.visible = true;
            lighter.position.set(2, -2, 0);

            setInstruction('YAKMAK İÇİN <span class="key">SOL TIK</span> BASILI TUTUP UCUNA GÖTÜR');
        }

        function updateLightLogic() {
            // Lighter mouse takip etsin (Basılı tutunca)
            if(STATE.isMouseDown) {
                // Mouse 3D pozisyon tahmini (Basit)
                const targetX = STATE.mouse.x * 10;
                const targetY = STATE.mouse.y * 10;
                
                // Lerp ile yumuşak takip
                lighter.position.x += (targetX - lighter.position.x) * 0.1;
                lighter.position.y += (targetY - lighter.position.y) * 0.1;
                
                flame.visible = true;

                // Mesafe kontrolü
                const tipPos = new THREE.Vector3(1.75 + joint.position.x, joint.position.y, 0);
                const flamePos = lighter.position.clone().add(new THREE.Vector3(0, 1.4, 0));
                
                if(flamePos.distanceTo(tipPos) < 1.5) {
                    STATE.progress += 1;
                    updateProgress(STATE.progress);
                    
                    // Uç kızarsın
                    const ember = joint.children[1];
                    ember.material.emissiveIntensity = STATE.progress / 20;
                    ember.children[0].intensity = STATE.progress / 20;

                    if(STATE.progress >= 100) {
                        STATE.phase = 'TRANSITION';
                        lighter.visible = false;
                        setTimeout(startSmokePhase, 500);
                    }
                }
            } else {
                flame.visible = false;
            }
        }

        // FAZ 4: İÇME
        function startSmokePhase() {
            STATE.phase = 'SMOKE';
            updateProgress(100); // Full bar
            
            // Sigara merkeze
            gsap.to(joint.position, { x: 0, y: -2, z: 2, duration: 1 });
            gsap.to(joint.rotation, { z: Math.PI / 2, duration: 1 }); // Dik konuma

            setInstruction('<span class="key">SOL TIK</span> İÇ | <span class="key">BIRAK</span> ÜFLE');
        }

        function updateSmokeLogic() {
            const ember = joint.children[1];

            if(STATE.isMouseDown) {
                // İÇME (Inhale)
                camera.position.z = THREE.MathUtils.lerp(camera.position.z, 8, 0.05); // Zoom
                ember.material.emissiveIntensity = 2 + Math.random(); // Titrek ışık
                ember.children[0].intensity = 2;
                
                // Sigara kısalıyor
                joint.children[0].scale.y *= 0.999; 
                
                // Köz pozisyonu güncelle (Basitçe X ekseninde geriye çek)
                // Gerçekçi olması için scale'e bağlı pozisyon hesabı gerekir ama
                // bu basit versiyonda görsel hile yeterli.
                
            } else {
                // İÇMEME (Exhale/Idle)
                camera.position.z = THREE.MathUtils.lerp(camera.position.z, 10, 0.02);
                ember.material.emissiveIntensity = 0.5;
                ember.children[0].intensity = 0.5;
            }
        }

        // --- INPUT YÖNETİMİ ---
        function setupInputs() {
            // Grinding Tıklama
            document.addEventListener('mousedown', () => {
                if(STATE.phase === 'GRIND') handleGrindClick();
            });

            // Rolling Space
            document.addEventListener('keydown', (e) => {
                if(e.code === 'Space' && STATE.phase === 'ROLL') STATE.isSpaceDown = true;
            });
            document.addEventListener('keyup', (e) => {
                if(e.code === 'Space') STATE.isSpaceDown = false;
                // Smoking Exhale Trigger
                if(STATE.phase === 'SMOKE') createSmokeCloud();
            });
            
            // Smoking Mouse Up (Exhale)
            document.addEventListener('mouseup', () => {
                if(STATE.phase === 'SMOKE') createSmokeCloud();
            });
        }

        function onMouseMove(e) {
            STATE.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            STATE.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            // Sigara takip (Smoke modunda)
            if(STATE.phase === 'SMOKE' && joint) {
                gsap.to(joint.rotation, { 
                    x: STATE.mouse.y * 0.5, 
                    y: STATE.mouse.x * 0.5, 
                    duration: 0.5 
                });
            }
        }

        // --- EFEKTLER ---
        function createSmokeTexture() {
            const c = document.createElement('canvas'); c.width=64; c.height=64;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(32,32,0,32,32,32);
            g.addColorStop(0,'rgba(255,255,255,0.3)'); g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,64,64);
            return new THREE.CanvasTexture(c);
        }
        const smokeTex = createSmokeTexture();

        function createSmokeCloud() {
            // Duman üfle
            for(let i=0; i<15; i++) {
                const mat = new THREE.SpriteMaterial({ map: smokeTex, color: 0xdddddd, transparent: true, opacity: 0.4 });
                const sprite = new THREE.Sprite(mat);
                sprite.position.set((Math.random()-0.5)*2, -2, 6);
                sprite.scale.set(1.5, 1.5, 1.5);
                sprite.userData = { 
                    vel: new THREE.Vector3((Math.random()-0.5)*0.02, 0.03+Math.random()*0.02, 0),
                    life: 1.0 
                };
                scene.add(sprite);
                smokeParticles.push(sprite);
            }
        }

        // --- ANA DÖNGÜ ---
        function animate() {
            requestAnimationFrame(animate);
            
            // Faz Mantığı
            if(STATE.phase === 'ROLL' && STATE.isSpaceDown) updateRollLogic();
            if(STATE.phase === 'LIGHT') updateLightLogic();
            if(STATE.phase === 'SMOKE') updateSmokeLogic();

            // Parçacık Güncelleme
            for(let i=smokeParticles.length-1; i>=0; i--) {
                const p = smokeParticles[i];
                p.position.add(p.userData.vel);
                p.scale.addScalar(0.01);
                p.userData.life -= 0.005;
                p.material.opacity = p.userData.life * 0.4;
                if(p.userData.life <= 0) {
                    scene.remove(p);
                    smokeParticles.splice(i,1);
                }
            }

            renderer.render(scene, camera);
            
            // UI Güncelleme
            document.getElementById('phase-display').innerText = STATE.phase;
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Başlat
        init();

    </script>
</body>
</html>
